# 7.3 数据通路

数据通路指数据在CPU内部各功能部件之间传送的路径。理解数据通路对于掌握CPU的工作原理至关重要。

---

## 7.3.1 数据通路的基本概念

### 定义

**数据通路**：数据在CPU内部各功能部件（寄存器、ALU、主存接口等）之间传送的路径。

### 组成要素

*   **功能部件**：寄存器、ALU、主存接口等
*   **数据总线**：连接各功能部件的通路
*   **控制信号**：控制数据流动的方向和时机

---

## 7.3.2 数据通路结构及其设计

数据通路设计是CPU设计的核心环节，需要系统性地规划指令执行所需的功能部件及其连接方式。

### 数据通路设计的一般步骤

#### 1. 拟定指令系统

*   **确定指令格式**：指令长度、操作码位数、地址码位数等
*   **确定指令功能**：每条指令要完成的操作
*   **确定寻址方式**：如寄存器寻址、直接寻址、间接寻址等
*   **示例**：规整型指令、寄存器寻址方式

#### 2. 确定总体结构

*   **分析每条指令的执行流程**：确定指令执行需要经过哪些阶段
*   **确定功能部件**：分析每条指令信息流经的功能部件
    *   **寄存器**：PC（程序计数器）、IR（指令寄存器）、通用寄存器（如R₀, R₁, ...）
    *   **运算部件**：ALU（算术逻辑单元）
    *   **存储接口**：MAR（存储器地址寄存器）、MDR（存储器数据寄存器）
*   **确定连接方式**：单总线、多总线或其他连接方式

#### 3. 安排好工作时序

*   **拟定指令流程**：将指令执行划分为多个阶段（如取指、译码、执行、访存、写回）
*   **拟定微命令序列**：确定每个阶段需要哪些微操作控制信号
*   **时序控制**：确保各微操作在正确的时刻执行

#### 4. 形成控制逻辑实现

*   **选择控制方式**：
    *   **组合逻辑型（硬布线控制器）**：由组合逻辑电路直接产生控制信号
    *   **微程序控制型**：通过执行微程序产生控制信号
*   **实现控制逻辑**：根据指令的操作码和执行阶段，产生相应的微操作控制信号

### 设计考虑因素

*   **功能完整性**：数据通路必须能够支持所有指令的执行
*   **性能优化**：减少数据传送次数，提高执行效率
*   **成本控制**：在满足功能的前提下，尽量简化硬件结构
*   **可扩展性**：便于后续添加新指令或功能

---

## 7.3.3 数据通路实例分析

### 指令：ADD @R₀, R₁

**指令功能**：$M[(R_0)] + (R_1) \to M[(R_0)]$

即：以R₀寄存器的内容为地址，从主存取出被加数，与R₁寄存器的内容（加数）相加，结果存回原主存地址。

:::details 间接寻址说明

**`@R₀` 表示间接寻址（Indirect Addressing）**：

*   **符号 `@`**：在指令中表示间接寻址，表示"以...为地址"
*   **间接寻址的含义**：
    *   R₀寄存器中存放的不是操作数本身，而是**操作数的地址**
    *   需要先访问R₀获取地址，再根据该地址访问主存获取实际的操作数
    *   这是一个**两次访存**的过程

**寻址方式对比**：

| 寻址方式 | 表示方法 | 操作数获取 | 访存次数 |
|:--------:|:--------:|:----------:|:--------:|
| **寄存器寻址** | `R₁` | 直接从寄存器R₁读取 | 0次 |
| **间接寻址** | `@R₀` | 先读R₀得地址，再根据地址读主存 | 1次（读主存） |
| **直接寻址** | `[地址]` | 直接根据指令中的地址读主存 | 1次（读主存） |

**间接寻址的执行过程**：

1.  **第一步**：读取R₀寄存器的内容，得到操作数的地址（例如：100H）
2.  **第二步**：以该地址访问主存，读取实际的操作数（例如：50H）

**为什么使用间接寻址？**

*   **灵活性**：可以通过修改R₀的值来访问不同的内存位置，而不需要修改指令
*   **指针功能**：R₀相当于一个指针，指向主存中的操作数
*   **动态寻址**：程序运行时可以动态改变R₀的值，实现动态数据访问

**在本指令中的体现**：

*   `@R₀`：表示被加数在主存中，地址存放在R₀中
*   `R₁`：表示加数直接存放在寄存器R₁中（寄存器寻址）
*   因此，执行时需要先从主存读取被加数（间接寻址），再与R₁中的加数相加

:::

**执行过程**：

![ADD @R₀, R₁](image.png)

#### 1. 取指阶段（公共操作）

*   $(PC) \to MAR$：程序计数器的内容送至存储器地址寄存器
*   $Read$：主存读命令
*   $M[MAR] \to MDR$：主存将指令送至存储器数据寄存器
*   $(MDR) \to IR$：MDR的内容送至指令寄存器
*   $(PC) + 1 \to PC$：程序计数器加1，指向下一条指令

![ADD @R₀, R₁](image2.png)

#### 2. 分析取数阶段（获取被加数）

*   $(R_0) \to MAR$：R₀内容作为地址送至MAR
*   $Read$：主存读命令
*   $M[MAR] \to MDR$：从主存读取被加数至MDR
*   $(MDR) \to Y$：被加数暂存到寄存器Y

![ADD @R₀, R₁](image3.png)

#### 3. 执行阶段

*   $(R_1) + (Y) \to Z$：ALU执行加法，R₁与Y相加，结果暂存到寄存器Z
*   $(Z) \to MDR$：结果送MDR，准备写回主存
*   $(R_0) \to MAR$：再次将地址送MAR
*   $Write$：主存写命令，将MDR的内容写入$M[MAR]$指定的单元

![ADD @R₀, R₁](image4.png)

---

## 7.3.4 数据通路设计要点

### 1. 单总线结构

*   **特点**：所有部件共享一条数据总线
*   **优点**：结构简单，成本低
*   **缺点**：同一时刻只能有一个数据传送，效率较低

### 2. 多总线结构

*   **特点**：多条数据总线，可并行传送数据
*   **优点**：效率高，性能好
*   **缺点**：结构复杂，成本高

### 3. 数据通路设计原则

*   **功能完整性**：能够支持所有指令的执行
*   **效率优化**：尽量减少数据传送次数
*   **控制简化**：便于控制信号的生成

---

## 总结

数据通路是CPU内部数据流动的路径，理解数据通路有助于分析指令的执行过程。通过分析具体指令（如ADD @R₀, R₁）在数据通路上的信息流，可以深入理解CPU的工作原理。

