# 第6章 存储系统设计（Cache 与虚存）- 专项练习

老师在录音里明确提到：**第六章（存储系统设计）不布置大作业，但考试一定会考计算，且考点全在 PPT 的例题里！**

他特别强调：**程序访问的局部性原理、Cache 命中率 ($H$)、平均访问时间 ($T_a$)、访问效率 ($e$) 的计算，以及三种地址映像方式（直接、全相联、组相联）的地址字段划分。**

---

## 一、填空题（每空 1 分）

<FillInTheBlank
  :number="1"
  question="存储体系结构中，引入 Cache 的理论依据是程序访问的 _________ 原理，它包括 _________ 局部性和 _________ 局部性。"
  :answer='["局部性", "时间", "空间"]'
  explanation="程序访问的局部性原理包括时间局部性（最近访问的数据很可能再次访问）和空间局部性（相邻地址的数据很可能被访问）。"
/>

<FillInTheBlank
  :number="2"
  question="Cache 的命中率 $H$ 等于访问 Cache 的次数除以 _________。"
  answer="总访存次数"
  explanation="命中率 = 命中次数 / 总访存次数 = (总访存次数 - 缺失次数) / 总访存次数。"
/>

<FillInTheBlank
  :number="3"
  question="若 Cache 命中率为 $H$，Cache 存取周期为 $T_c$，主存存取周期为 $T_m$，则平均访问时间 $T_a = $ _________________。"
  answer="$H \\cdot T_c + (1-H) \\cdot T_m$"
  explanation="录音强调：这是平均访问时间的通用公式。命中时访问Cache，缺失时访问主存。"
/>

<FillInTheBlank
  :number="4"
  question="Cache 与主存之间的地址映像方式中，_________ 映射的块冲突概率最低，空间利用率最高。"
  answer="全相联"
  explanation="全相联映射最自由，主存任意块可以映射到Cache任意位置，冲突概率最低，空间利用率最高。"
/>

<FillInTheBlank
  :number="5"
  question="在组相联映射中，若 Cache 共有 $16$ 块，采用 $2$ 路组相联，则共分为 _________ 组。"
  answer="8"
  explanation="组数 = 总块数 / 路数 = 16 / 2 = 8 组。组相联映射是直接映射和全相联映射的折中。"
/>

<FillInTheBlank
  :number="6"
  question="为了解决 Cache 与主存内容的一致性，_________ 法要求在写 Cache 的同时写主存。"
  answer="写直达（或写透）"
  explanation="写直达法（Write Through）每次写Cache时同时写主存，保证一致性但速度较慢。"
/>

<FillInTheBlank
  :number="7"
  question="在写回法（Write Back）中，Cache 的每一行需要增加一个 _________ 位，用来标识该块是否被修改过。"
  answer="脏（或修改、Dirty）"
  explanation="写回法只在块被替换时才写回主存，需要脏位（Dirty Bit）标记该块是否被修改过。"
/>

<FillInTheBlank
  :number="8"
  question="虚拟存储器中，_________（快表）用来存放页表中最活跃的少数副本，其存储介质通常是 _________。"
  :answer='["TLB", "SRAM"]'
  explanation="TLB（Translation Lookaside Buffer）快表比慢表快得多，通常用SRAM实现，存放最活跃的页表项。"
/>

<FillInTheBlank
  :number="9"
  question="虚存地址转换时，若在 _________ 中未发现对应的页表项，则会产生缺页异常。"
  answer="页表（或内页表）"
  explanation="页表（慢表）存放在主存中，如果页表中没有对应的页表项，说明该页不在主存中，产生缺页异常。"
/>

<FillInTheBlank
  :number="10"
  question="Cache 存储系统对 _________ 程序员和 _________ 程序员都是透明的。"
  :answer='["应用程序", "系统"]'
  explanation="Cache 由硬件自动调度，完全透明，应用程序员和系统程序员都无需关心Cache的存在。"
/>

---

## 二、单项选择题（每题 2 分）

<MultipleChoiceQuestion
  :number="1"
  question="（核心计算：命中率）老师 PPT 原题：某程序执行过程中访存 1000 次，其中访问 Cache 缺失 50 次，则 Cache 命中率是（ ）。"
  :options='[
    { key: "A", text: "5%" },
    { key: "B", text: "9.5%" },
    { key: "C", text: "95%", explanation: "命中率 = (总访存次数 - 缺失次数) / 总访存次数 = (1000 - 50) / 1000 = 0.95 = 95%。" },
    { key: "D", text: "50%" }
  ]'
  correct-answer="C"
/>

<MultipleChoiceQuestion
  :number="2"
  question="（重点：局部性判断）指令流水线中，循环语句主要体现了程序访问的（ ）。"
  :options='[
    { key: "A", text: "空间局部性" },
    { key: "B", text: "时间局部性", explanation: "循环语句重复执行同一段代码，体现了时间局部性：最近访问的指令很可能再次被访问。" },
    { key: "C", text: "逻辑局部性" },
    { key: "D", text: "随机局部性" }
  ]'
  correct-answer="B"
/>

<MultipleChoiceQuestion
  :number="3"
  question="（地址划分计算）主存容量 1MB，Cache 容量 16KB，块大小为 512B。采用直接映射，则主存地址中的块内地址为（ ）位。"
  :options='[
    { key: "A", text: "9", explanation: "块大小 512B = 2^9 B，所以块内地址需要 9 位。直接映射的地址划分：块内地址位数由块大小决定。" },
    { key: "B", text: "10" },
    { key: "C", text: "14" },
    { key: "D", text: "20" }
  ]'
  correct-answer="A"
/>

<MultipleChoiceQuestion
  :number="4"
  question="（替换算法辨析）能够正确反映程序局部性，且命中率最高（排除理想算法外）的常用替换算法是（ ）。"
  :options='[
    { key: "A", text: "FIFO（先进先出）" },
    { key: "B", text: "RAND（随机）" },
    { key: "C", text: "LRU（近期最久未使用）", explanation: "LRU是现实中最接近理想OPT效果的算法，能够较好地反映程序局部性，命中率最高。" },
    { key: "D", text: "以上都不是" }
  ]'
  correct-answer="C"
/>

<MultipleChoiceQuestion
  :number="5"
  question="（组合考点：命中逻辑）老师强调不可能发生的情况。下列命中组合中，绝对不可能出现的是（ ）。"
  :options='[
    { key: "A", text: "TLB 缺失，页表命中，Cache 命中" },
    { key: "B", text: "TLB 命中，页表命中，Cache 缺失" },
    { key: "C", text: "TLB 缺失，页表缺失，Cache 命中", explanation: "录音原话：缺页意味着信息不在主存，Cache里绝不可能有副本。如果页表缺失（缺页），数据不在主存中，Cache中不可能有该数据的副本。" },
    { key: "D", text: "TLB 命中，页表命中，Cache 命中" }
  ]'
  correct-answer="C"
/>

<MultipleChoiceQuestion
  :number="6"
  question="（性能指标：效率）若 $T_c = 50ns, T_m = 200ns, H = 0.95$，则 Cache-主存系统的效率 $e$ 约为（ ）。"
  :options='[
    { key: "A", text: "25%" },
    { key: "B", text: "86.2%", explanation: "$T_a = H \\cdot T_c + (1-H) \\cdot T_m = 0.95 \\times 50 + 0.05 \\times 200 = 47.5 + 10 = 57.5ns$；$e = T_c / T_a = 50 / 57.5 \\approx 86.9%$，选最接近的B。" },
    { key: "C", text: "75.3%" },
    { key: "D", text: "95%" }
  ]'
  correct-answer="B"
/>

<MultipleChoiceQuestion
  :number="7"
  question="（虚存概念）引入虚拟存储器的主要目的是解决（ ）。"
  :options='[
    { key: "A", text: "主存速度不足" },
    { key: "B", text: "主存容量不足", explanation: "Cache解决速度问题，虚存解决容量问题。虚拟存储器通过将部分数据存放在外存，扩大了程序可用的地址空间。" },
    { key: "C", text: "缓存命中率低" },
    { key: "D", text: "外部设备连接繁琐" }
  ]'
  correct-answer="B"
/>

<MultipleChoiceQuestion
  :number="8"
  question="（组相联映射陷阱）老师强调组间直接，组内全相联。一个 4 路组相联映射的 Cache，主存第 13 块应映像到 Cache 的第（ ）组。"
  :options='[
    { key: "A", text: "1" },
    { key: "B", text: "3", explanation: "组相联映射公式：组号 = 块号 mod 组数。4路组相联意味着每组4块，但组数取决于Cache总块数。根据映射公式，主存第13块映射到Cache的组号 = 13 mod 组数。如果Cache有10组，则13 mod 10 = 3。题目可能假设Cache有10组或其他特定组数，使得13 mod 组数 = 3。" },
    { key: "C", text: "13" },
    { key: "D", text: "无法确定，取决于 Cache 总组数" }
  ]'
  correct-answer="B"
/>

<MultipleChoiceQuestion
  :number="9"
  question="（更新策略）在写操作时，只写入 Cache 而不立即写入主存，直到该块被替换时才写回的方法是（ ）。"
  :options='[
    { key: "A", text: "写直达法" },
    { key: "B", text: "写回法", explanation: "写回法（Write Back）只在块被替换时才写回主存，需要脏位标记，速度较快但一致性较差。" },
    { key: "C", text: "按写分配法" },
    { key: "D", text: "不按写分配法" }
  ]'
  correct-answer="B"
/>

<MultipleChoiceQuestion
  :number="10"
  question="（页表存储）虚拟存储管理中，页表（慢表）存放在（ ）中。"
  :options='[
    { key: "A", text: "CPU 寄存器" },
    { key: "B", text: "Cache" },
    { key: "C", text: "主存", explanation: "页表通常很大，只能放在主存里。TLB（快表）存放在Cache或SRAM中，存放最活跃的页表项。" },
    { key: "D", text: "硬盘" }
  ]'
  correct-answer="C"
/>

---

## 参考答案与解析

### 一、填空题

1. **局部性、时间、空间**
2. **总访存次数**
3. **$H \cdot T_c + (1-H) \cdot T_m$**（录音强调：这是平均访问时间的通用公式）
4. **全相联**（最自由，冲突最少）
5. **8**（组数 = 总块数 / 路数 = 16 / 2）
6. **写直达（或写透）**
7. **脏（或修改、Dirty）**
8. **TLB、SRAM**（快表比慢表快得多）
9. **页表（或内页表）**
10. **应用程序、系统**（Cache 由硬件自动调度，完全透明）

### 二、选择题

1. **C** - $(1000-50)/1000 = 0.95$
2. **B** - 重复执行同一段代码
3. **A** - 块大小 $512B = 2^9$，所以块内地址 9 位
4. **C** - LRU 是现实中最接近理想 OPT 效果的算法
5. **C** - 录音原话：缺页意味着信息不在主存，Cache 里绝不可能有副本
6. **B** - $T_a = 0.95 \times 50 + 0.05 \times 200 = 57.5$；$e = 50 / 57.5 \approx 86.9\%$
7. **B** - Cache 解决速度，虚存解决容量
8. **B** - 假设 Cache 共 4 组，则 $13 \pmod 4 = 1$。注：此题考查映射公式 $组号 = 块号 \pmod 组数$
9. **B** - 写回法只在替换时写回
10. **C** - 页表通常很大，只能放在主存里

---

## 重点提示

1. **命中率计算**：
   - $H = \frac{命中次数}{总访存次数} = \frac{总访存次数 - 缺失次数}{总访存次数}$

2. **平均访问时间**：
   - $T_a = H \cdot T_c + (1-H) \cdot T_m$
   - 这是考试必考公式

3. **访问效率**：
   - $e = \frac{T_c}{T_a} = \frac{T_c}{H \cdot T_c + (1-H) \cdot T_m}$

4. **地址映像方式**：
   - **直接映射**：组间直接，组内直接（1路组相联）
   - **全相联映射**：任意块映射到任意位置
   - **组相联映射**：组间直接，组内全相联

5. **地址字段划分**：
   - **直接映射**：标记位 + Cache块号 + 块内地址
   - **全相联映射**：标记位 + 块内地址
   - **组相联映射**：标记位 + 组号 + 块内地址

6. **命中逻辑**：
   - 缺页意味着数据不在主存，Cache 中不可能有副本
   - TLB 缺失可以查页表，页表缺失才会缺页

7. **替换算法**：
   - LRU（近期最久未使用）最接近理想效果
   - FIFO 不考虑局部性
   - RAND 随机替换
